# 更新日志

## 版本 v2.1.0 (日期 TBD)

### ✨ 新功能 (Features)

-   **游戏内指令系统**: 添加了完整的游戏内指令系统 (`/tt20`)，允许管理员在不重启游戏或编辑文件的情况下实时管理模组。
    -   `/tt20 set cap <数值>`: 动态设置加速倍率上限。
    -   `/tt20 toggle <功能>`: 实时启用或禁用特定的加速功能。
    -   `/tt20 status`: 查看所有功能的当前状态、TPS及MSPT。
    -   `/tt20 mask list`: 显示方块实体黑/白名单的内容。
    -   `/tt20 mask type <whitelist|blacklist>`: 切换黑/白名单模式。
    -   `/tt20 mask [add|remove] <方块ID>`: 在游戏内直接管理黑/白名单。
    -   所有指令均支持权限控制和Tab自动补全。

### ⚙️ 底层重构与优化 (Refactoring & Improvements)

-   **配置格式迁移**: 配置文件已从 `JSON` 格式迁移到功能更强大、更易读的 `TOML` 格式。旧的 `config.json` 和 `block_entity_mask.json` 将被自动忽略。
-   **配置文件注释**: 新的 `config.toml` 和 `block_entity_mask.toml` 文件现在为每个配置项都提供了详细的注释，极大地提高了可配置性。
-   **配置代码重构**:
    -   完全重构了配置处理代码，使其更加健壮和面向对象。
    -   通过数据驱动的方式集中管理所有配置项（键、默认值、注释），消除了硬编码和重复代码，使未来维护和添加新功能变得更加简单。

---

## 近期更新 (2025-08-30)

这是一个重要的维护更新，主要修复了代码库中存在的多个严重错误，并对核心功能进行了重构和改进，显著提升了模组的稳定性、健壮性和性能。

### 🐛 修复 (Fixed)

-   **[严重]** 修复了 `BlockEntityMaskConfig` 的初始化逻辑。此前的错误会导致在处理区块实体（如箱子、熔炉）时发生 `NullPointerException`，从而引起游戏崩溃。
-   **[严重]** 修复了多个核心加速功能（如方块破坏、流体流动、物品使用等）的 Mixin 逻辑。该错误曾导致即使在配置中禁用了这些功能，加速效果依然会被错误地应用，可能引发非预期的游戏行为。
-   修复了配置文件处理类 (`JSONConfiguration`) 中的资源泄漏隐患，确保文件流被正确关闭。
-   增强了配置文件加载的健壮性，现在可以更好地处理文件为空或格式错误的情况，避免了潜在的崩溃。

### ✨ 优化 (Improved)

-   提升了配置项检查的性能，移除了不必要的内部数据转换。

### 🚀 功能改进 (Features & Improvements)

-   **配置系统重构**: 完全重构了 `MainConfig` 类，使其变为数据驱动。这极大地简化了未来添加新配置项的流程，减少了样板代码。
-   **命令系统增强**:
    -   `/tt20 status` 命令现在能动态显示所有配置项，不再需要硬编码。
    -   `/tt20 toggle` 命令现在变为 `/tt20 toggle <配置名>`，可以切换任意一个布尔类型的配置，并支持 Tab 自动补全。
-   **国际化 (i18n)**:
    -   为所有用户可见的文本（命令、状态消息）建立了翻译工具。
    -   所有硬编码的字符串都已被替换为语言文件中的键。
    -   添加了完整的英文 (`en_us`) 和中文 (`zh_cn`) 语言支持。

### ⚙️ 算法与稳定性 (Algorithm & Stability)

-   **平滑计算**: 核心的性能监测器 (`TPSCalculator`) 现在使用指数移动平均 (EMA) 算法来计算服务器的MSPT（每刻毫秒数）。这使得模组对服务器性能的判断更平滑、稳定，避免了因瞬间的性能抖动导致加速效果剧烈变化的问题。
-   **安全上限**: 为“补帧”逻辑增加了安全上限。现在，即使服务器瞬间严重卡顿并欠下大量tick，模组单次最多补偿的tick数也将被限制（默认为10）。这可以有效防止“卡顿->补偿->更卡顿”的恶性循环，极大地提升了服务器在极端情况下的稳定性。该上限可通过 `config.json` 中的 `tick-repeat-cap` 选项进行配置。
